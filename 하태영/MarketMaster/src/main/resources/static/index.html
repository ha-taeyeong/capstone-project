<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Market Master Pro - K-Trading Terminal</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    body { background-color: #0d1117; color: #c9d1d9; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; overflow: hidden; }
    .header { background: #161b22; padding: 0 30px; display: flex; justify-content: space-between; border-bottom: 1px solid #30363d; height: 70px; align-items: center; }
    .price-text { font-size: 26px; font-weight: bold; color: #f85149; }
    .mission-badge { color: #ffa726; font-weight: bold; border: 1px solid #ffa726; padding: 6px 18px; border-radius: 20px; font-size: 13px; }
    .mission-success { color: #3fb950 !important; border-color: #3fb950 !important; }
    #chart-container { width: 100vw; height: calc(100vh - 150px); position: relative; }
    .chart-legend { position: absolute; top: 20px; left: 20px; z-index: 10; background: rgba(22, 27, 34, 0.85); padding: 12px; border-radius: 8px; border: 1px solid #30363d; font-size: 12px; line-height: 1.6; pointer-events: none; }
    .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
    .footer { background: #161b22; height: 80px; display: flex; gap: 15px; justify-content: center; align-items: center; border-top: 1px solid #30363d; }
    .btn { padding: 10px 20px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; }
    .buy { background: #f85149; } .sell { background: #0082fb; }
    .qty-input-group { display: flex; align-items: center; gap: 8px; background: #0d1117; padding: 5px 15px; border-radius: 6px; border: 1px solid #30363d; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(13, 17, 23, 0.98); z-index: 4000; display: flex; align-items: center; justify-content: center; }
    .t-card { max-width: 800px; width: 95%; padding: 40px; background: #161b22; border: 1px solid #30363d; border-radius: 16px; text-align: center; }
    .t-vertical-container { display: flex; flex-direction: column; gap: 20px; align-items: center; }
    .t-img-box { width: 100%; background: #0d1117; border-radius: 12px; border: 1px solid #30363d; padding: 15px; display: flex; justify-content: center; }
    .t-img { max-width: 100%; max-height: 320px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
    .t-text-box { width: 100%; text-align: left; font-size: 16px; line-height: 1.6; color: #c9d1d9; border-top: 1px solid #30363d; padding-top: 15px; }
    #toast-container { position: fixed; top: 85px; left: 50%; transform: translateX(-50%); z-index: 5000; display: flex; flex-direction: column; align-items: center; }
  </style>
</head>
<body>

<div id="tutorial-overlay" class="modal-overlay">
  <div class="t-card">
    <div id="t-content"></div>
    <div style="display: flex; justify-content: space-between; margin-top: 30px;">
      <button class="btn" style="background: #30363d" onclick="moveTutorial(-1)">ì´ì „</button>
      <button class="btn buy" id="t-next" onclick="moveTutorial(1)">ë‹¤ìŒ ë‹¨ê³„</button>
    </div>
  </div>
</div>

<div id="review-modal" class="modal-overlay" style="display: none;">
  <div class="modal-card" style="max-height: 80vh; overflow-y: auto;">
    <h2 style="color: #f1e05a;">ğŸ“Š ë§¤ë§¤ ë³µê¸° ë¦¬í¬íŠ¸</h2>
    <table style="width:100%; border-collapse: collapse; margin-top:20px;">
      <thead style="background:#0d1117; color:#8b949e;">
      <tr><th>ì‹œê°„</th><th>êµ¬ë¶„</th><th>ì²´ê²°ê°€</th><th>ìˆ˜ëŸ‰</th><th>ì‹œê·¸ë„</th></tr>
      </thead>
      <tbody id="review-list"></tbody>
    </table>
    <button class="btn" style="background: #30363d; margin-top: 20px;" onclick="toggleReview(false)">ë‹«ê¸°</button>
  </div>
</div>

<div class="header">
  <div><span style="color: #8b949e;">LIVE:</span> <span id="price" class="price-text">0</span>ì›</div>
  <div id="mission-status" class="mission-badge">ğŸ¯ ë¯¸ì…˜: ì´ ìì‚° 1,100ë§Œ ì› ë‹¬ì„±</div>
  <div style="font-size: 16px;">ìì‚°: <span id="cash" style="color: #f85149;">10,000,000</span>ì› | ë³´ìœ : <span id="qty" style="color: #ffa726;">0</span>ì£¼</div>
</div>

<div id="chart-container">
  <div class="chart-legend">
    <div><span class="dot" style="background:#f1e05a"></span><b style="color:#f1e05a">MA5</b>: <span id="ma5-val">-</span></div>
    <div><span class="dot" style="background:#ff7b72"></span><b style="color:#ff7b72">MA20</b>: <span id="ma20-val">-</span></div>
    <div><span class="dot" style="background:#3fb950"></span><b style="color:#3fb950">MA60</b>: <span id="ma60-val">-</span></div>
    <div><span class="dot" style="background:#a371f7"></span><b style="color:#a371f7">MA120</b>: <span id="ma120-val">-</span></div>
  </div>
</div>
<div id="toast-container"></div>

<div class="footer">
  <div class="qty-input-group">
    <input type="number" id="trade-qty" value="10" min="1" style="width:50px; background:none; border:1px solid #30363d; color:white; padding:5px;">
    <span style="color: #8b949e; font-size: 12px;">ì£¼</span>
  </div>
  <button class="btn buy" onclick="handleTrade('BUY')">ì‹¤ì‹œê°„ ë§¤ìˆ˜</button>
  <button class="btn sell" onclick="handleTrade('SELL')">ì‹¤ì‹œê°„ ë§¤ë„</button>
  <button class="btn" style="background: #30363d;" onclick="toggleReview(true)">ğŸ“Š ë³µê¸°</button>
  <button class="btn" style="background: #f1e05a; color: black;" onclick="handleInject('golden')">ğŸš€ ê³¨ë“ </button>
  <button class="btn" style="background: #0082fb;" onclick="handleInject('dead')">ğŸ’€ ë°ë“œ</button>
  <button class="btn" style="background: #8b949e;" onclick="handleInject('reset')">ğŸ”„</button>
</div>

<script>
  let tradeLogs = [];

  function showToast(m, t) {
    const c = document.getElementById('toast-container'), toast = document.createElement('div');
    toast.innerText = m;
    toast.style.cssText = `padding: 12px 25px; margin-bottom: 10px; border-radius: 8px; color: white; background: ${t==='success'?'#f85149':'#0082fb'}; box-shadow: 0 4px 15px rgba(0,0,0,0.3);`;
    c.appendChild(toast);
    setTimeout(() => toast.remove(), 2500);
  }

  window.handleInject = (type) => {
    fetch(`/api/engine/trigger/${type}`, { method: 'POST' })
            .then(res => { if (res.ok) showToast(`${type.toUpperCase()} íŒ¨í„´ ì£¼ì… ì™„ë£Œ`, 'success'); });
  };

  window.toggleReview = (show) => {
    const modal = document.getElementById('review-modal');
    modal.style.display = show ? 'flex' : 'none';
    if (show) {
      document.getElementById('review-list').innerHTML = tradeLogs.map(log => `
        <tr><td>${new Date(log.time * 1000).toLocaleTimeString()}</td><td style="color:${log.type==='BUY'?'#f85149':'#0082fb'}; font-weight:bold;">${log.type==='BUY'?'ë§¤ìˆ˜':'ë§¤ë„'}</td><td>${log.price.toLocaleString()}ì›</td><td>${log.qty}ì£¼</td><td style="color:#ffa726;">${log.sig}</td></tr>`).join('');
    }
  };

  // --- ê°€ì´ë“œ ë°ì´í„°: ìˆ˜ì‹ ë¬¸ë²• ìˆ˜ì • (LaTeX) ---
  const steps = [
    { title: "1. ìº”ë“¤ê³¼ ì‹¬ë¦¬ì˜ ê¸°ì´ˆ", desc: "<b style='color:#f85149'>ì–‘ë´‰(ë¹¨ê°•)</b>ì€ ìƒìŠ¹ì„, <b style='color:#0082fb'>ìŒë´‰(íŒŒë‘)</b>ì€ í•˜ë½ì„ ëœ»í•©ë‹ˆë‹¤.", imgTag: `<img src="/images/guide_candle.png" class="t-img">` },
    { title: "2. 4ì¤‘ ì´ë™í‰ê· ì„ (MA) ì½ê¸°", desc: "5Â·20Â·60Â·120ì¼ ì„ ì„ í†µí•´ ì‹œì¥ì˜ ì¥ë‹¨ê¸° íë¦„ì„ í•œëˆˆì— íŒŒì•…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.", imgTag: `<img src="/images/guide_ma.png" class="t-img">` },
    { title: "3. ê³¨ë“ /ë°ë“œí¬ë¡œìŠ¤ ì „ëµ", desc: "ì´í‰ì„ ë“¤ì´ êµì°¨í•˜ë©° ë‚˜íƒ€ë‚˜ëŠ” ì‹œê·¸ë„ì„ í†µí•´ ë§¤ìˆ˜ì™€ ë§¤ë„ íƒ€ì´ë°ì„ ê²°ì •í•©ë‹ˆë‹¤.", imgTag: `<img src="/images/guide_cross.png" class="t-img">` },
    {
      title: "4. ê¸ˆìœµê³µí•™ GBM ì—”ì§„",
      // â­ 2. ê·¸ë¦¬ìŠ¤ ë¬¸ì(\mu, \sigma) ë° ìˆ˜ì‹ ê¸°í˜¸ ì ìš© â­
      desc: "ë³¸ í”Œë«í¼ì€ ì‹¤ì œ ê¸ˆìœµ ìˆ˜ì‹ì¸ \\( dS_t = \\mu S_t dt + \\sigma S_t dW_t \\) ëª¨ë¸(GBM)ì„ ê¸°ë°˜ìœ¼ë¡œ ì‹¤ì‹œê°„ ì‹œì„¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.",
      imgTag: `<img src="/images/guide_gbm.png" class="t-img">`
    }
  ];

  let tIdx = 0;
  function moveTutorial(dir) {
    tIdx += dir;
    if (tIdx < 0) tIdx = 0;
    if (tIdx >= steps.length) { document.getElementById('tutorial-overlay').style.display='none'; initApp(); return; }

    const s = steps[tIdx];
    document.getElementById('t-content').innerHTML = `
      <h2 style="color:#f1e05a; margin-bottom:15px;">${s.title}</h2>
      <div class="t-vertical-container">
        <div class="t-img-box">${s.imgTag}</div>
        <div class="t-text-box">${s.desc}</div>
      </div>
    `;
    document.getElementById('t-next').innerText = tIdx === steps.length - 1 ? "ê²Œì„ ì‹œì‘" : "ë‹¤ìŒ ë‹¨ê³„";

    // â­ 3. í˜ì´ì§€ ì „í™˜ ì‹œ MathJaxì—ê²Œ ìˆ˜ì‹ì„ ë Œë”ë§í•˜ë¼ê³  ëª…ë ¹ â­
    if (window.MathJax) {
      MathJax.typesetPromise();
    }
  }
  moveTutorial(0);

  function initApp() {
    const container = document.getElementById('chart-container');
    const tvChart = LightweightCharts.createChart(container, { layout: { background: { color: '#0d1117' }, textColor: '#c9d1d9' }, grid: { vertLines: { color: '#21262d' }, horzLines: { color: '#21262d' } }, timeScale: { timeVisible: true, secondsVisible: true } });
    const candleSeries = tvChart.addCandlestickSeries({ upColor: '#f85149', downColor: '#0082fb', borderVisible: false, wickUpColor: '#f85149', wickDownColor: '#0082fb' });
    const maLines = { 5: tvChart.addLineSeries({ color: '#f1e05a', lineWidth: 1 }), 20: tvChart.addLineSeries({ color: '#ff7b72', lineWidth: 1 }), 60: tvChart.addLineSeries({ color: '#3fb950', lineWidth: 1 }), 120: tvChart.addLineSeries({ color: '#a371f7', lineWidth: 1 }) };
    let priceHistory = [], markers = [], cash = 10000000, qty = 0, currentCandle = null, missionCleared = false;
    const socket = new SockJS('/ws-market');
    const stomp = Stomp.over(socket);
    stomp.debug = null;
    stomp.connect({}, () => {
      stomp.subscribe('/topic/ticker', (tick) => {
        const candle = JSON.parse(tick.body);
        currentCandle = candle;
        candleSeries.update(candle);
        document.getElementById('price').innerText = candle.close.toLocaleString();
        priceHistory.push(candle.close);
        if (priceHistory.length > 150) priceHistory.shift();
        [5, 20, 60, 120].forEach(p => { if (priceHistory.length >= p) { const avg = priceHistory.slice(-p).reduce((a, b) => a + b) / p; maLines[p].update({ time: candle.time, value: avg }); document.getElementById(`ma${p}-val`).innerText = Math.floor(avg).toLocaleString(); } });
        const totalAsset = cash + (qty * candle.close);
        if (!missionCleared && totalAsset >= 11000000) { missionCleared = true; document.getElementById('mission-status').classList.add('mission-success'); showToast("ğŸŠ ë¯¸ì…˜ ì„±ê³µ!", "success"); }
      });
    });
    window.handleTrade = (type) => {
      const tQty = parseInt(document.getElementById('trade-qty').value);
      const price = currentCandle.close;
      const ma5 = priceHistory.slice(-5).reduce((a,b)=>a+b)/5;
      const ma20 = priceHistory.slice(-20).reduce((a,b)=>a+b)/20;
      let sig = (ma5 > ma20 * 1.001) ? "ê³¨ë“ " : (ma5 < ma20 * 0.999) ? "ë°ë“œ" : "ì¼ë°˜";
      if (type === 'BUY' && cash >= price * tQty) { cash -= price * tQty; qty += tQty; tradeLogs.push({ time: currentCandle.time, type: 'BUY', price, qty: tQty, sig }); addMarker(currentCandle.time, 'buy', `ë§¤ìˆ˜ ${tQty}ì£¼ (${sig})`); }
      else if (type === 'SELL' && qty >= tQty) { cash += price * tQty; qty -= tQty; tradeLogs.push({ time: currentCandle.time, type: 'SELL', price, qty: tQty, sig }); addMarker(currentCandle.time, 'sell', `ë§¤ë„ ${tQty}ì£¼ (${sig})`); }
      document.getElementById('cash').innerText = cash.toLocaleString();
      document.getElementById('qty').innerText = qty.toLocaleString();
    };
    function addMarker(time, type, label) { markers.push({ time, position: type === 'buy' ? 'belowBar' : 'aboveBar', color: type === 'buy' ? '#f85149' : '#0082fb', shape: type === 'buy' ? 'arrowUp' : 'arrowDown', text: label }); candleSeries.setMarkers(markers); }
  }
</script>
</body>
</html>